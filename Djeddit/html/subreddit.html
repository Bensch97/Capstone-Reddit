{% extends 'base.html' %}

{% block page_title %}
  <span>r/{{ subreddit.name }}</span>
{% endblock %}

{% block content %}
    <a class="btn btn-primary ml-1 my-1" href="/post/{{ subreddit.name }}">Create Post</a>
      {% if subreddit not in subscriptions %}
        <a class='btn btn-primary ml-1 my-1' href='/subscribe/{{ subreddit.name }}/'>Subscribe</a>
      {% endif %}
      {% if subreddit in subscriptions %}
      <a class='btn btn-primary ml-1 my-1' href='/unsubscribe/{{ subreddit.name }}/'>Unsubscribe</a>
      {% endif %}
    {% for post in posts %}
    <div class="col-11">
      <div class="list-group m-1">
        <div
          class="list-group-item list-group-item-action flex-column align-items-start"
        >
        <div class="row">
            <div class="upvotes col-md-2">
                    {% include "vote.html" %}
            </div>
            <div class="subreddit-posts col-md-10">
                <div class="d-flex w-100">
                    <p class='font-weight-bold'><a href='/r/{{ post.subreddit_id.name }}/' class='text-dark'>r/{{ post.subreddit_id.name }}</a></p><p class='font-weight-light ml-1'>Posted by <a href='/u/{{ post.profile_id.username }}' class='text-muted'>u/{{ post.profile_id.username }}</a> at {{ post.timestamp }}</p>
                </div>
                <div class="title-post">
                    <h5 class='mb-1'><a href='/p/{{ post.id }}' class='text-dark'>{{ post.title }}</a></h5>
                    <p>{{ post }}</p>
                </div>
            </div>
        </div>   

        </div>
      </div>
    </div>
    {% endfor %}
{% endblock %}
{% block  javascript %}
<script>
// jquery AJAX for voting
$(function() {
    var myForm = $(".vote-form")
    myForm.submit(function() {
      var btn = $(this).find("button")
      var otherButton = {}
      $.ajax({
        url: $(this).attr('action'),
        type: $(this).attr('method'),
        data: $(this).serialize(),
        }).done(function(data) {
          // checks if upvote and assigns element to variable
          otherButton = (data.vote_type == "upvote" ?  $(`#down-arrow-${data.post_id}`) : $(`#up-arrow-${data.post_id}`))
          // checks if clicked button is already orange
          switch (btn.css("background-color") == "rgb(255, 165, 0)") {
            case true:
              otherButton.css("background-color") == "rgb(255, 165, 0)" ? otherButton.css("background-color","") : null
              btn.css("background-color","")
              break;
            case false:
              otherButton.css("background-color") == "rgb(255, 165, 0)" ? otherButton.css("background-color","") : null
              btn.css("background-color","orange")
          }
          // assign score element and update element's html from backend data
          var score = $(`#score-${data.post_id}`)
          score.html(data.updated_score)
        }).fail(function(error) {
          alert(error)
        });
    // ensures page does not redirect or refresh
    return false
    });
});
</script>
{% endblock %}